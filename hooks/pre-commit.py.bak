#!/usr/bin/env python


import glob
import os
import re
import subprocess
import sys

modified_re = re.compile(r'^[AM]+\s+(?P<name>.*\.py)', re.MULTILINE)


def get_staged_files():
    """Get all files staged for the current commit.
    """
    proc = subprocess.Popen(('git', 'status', '--porcelain'),
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE)
    out, _ = proc.communicate()
    staged_files = modified_re.findall(out)
    return staged_files


def main():
    abort = False
    # Stash un-staged changes.
    subprocess.call(('git', 'stash', '-u', '--keep-index'),
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,)
    # Determine all files staged for commit.
    staged_files = get_staged_files()
    # Enforce PEP8 conformance.
    print
    print '============ Enforcing PEP8 rules ============='
    for filename in staged_files:
        subprocess.call(('pep8ify', '-w', filename))
        subprocess.call(('git', 'add', '-q', 'filename'))
    print
    print '========== Checking PEP8 conformance =========='
    for filename in staged_files:
        proc = subprocess.Popen(('pep8', filename),
                                stdout=subprocess.PIPE)
        output, _ = proc.communicate()
        # If pep8 still reports problems then abort this commit.
        if output:
            abort = True
            print
            print '========= Found PEP8 non-conformance =========='
            print output

    # Remove .bak files created by PEP8ify.
    for filename in staged_files:
        try:
            os.unlink(filename + '.bak')
        except OSError:
            continue
    # Run unit tests.
    print
    print '============== Running unit tests ============='
    print
    proc = subprocess.Popen(['python', 'pytest.py', 'tests'],
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE)
    out, _ = proc.communicate()
    print out
    if 'FAILURES' in out:
        abort = True
    # Un-stash un-staged changes.
    subprocess.call(('git', 'stash', 'pop', '-q'),
                    stdout=subprocess.PIPE)
    # Should we abort this commit?
    if abort:
        sys.exit(1)
    else:
        sys.exit(0)
    return


if __name__ == '__main__':
    main()
